<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>V√©rifie Allerg√®nes</title>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
      :root {
        --primary: #2563eb;
        --danger: #dc2626;
        --success: #16a34a;
        --bg: #f8fafc;
        --card: #ffffff;
        --text: #1e293b;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 500px;
        margin: 0 auto;
        padding: 15px;
        padding-bottom: 100px;
      }

      header {
        text-align: center;
        padding: 20px 0;
        position: relative;
      }
      
      /* Style pour le bouton de langue */
      .lang-toggle {
        position: absolute;
        top: 10px;
        right: 0;
        padding: 5px 10px;
        font-size: 0.7rem;
        background: white;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        cursor: pointer;
      }

      header h1 {
        margin: 0;
        font-size: 1.6rem;
        color: var(--primary);
        letter-spacing: -0.5px;
      }

      .card {
        background: var(--card);
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 15px;
      }

      .tabs {
        display: flex;
        gap: 4px;
        background: #e2e8f0;
        padding: 4px;
        border-radius: 12px;
        margin-bottom: 15px;
      }
      .tab {
        flex: 1;
        padding: 10px 5px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        background: transparent;
        font-weight: 600;
        font-size: 0.75rem;
        transition: 0.2s;
      }
      .tab.active {
        background: white;
        color: var(--primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .input-group {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }
      select, input, textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        font-size: 1rem;
      }
      .btn {
        padding: 12px 18px;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
      }
      .btn-primary { background: var(--primary); color: white; }
      .btn-secondary { background: #64748b; color: white; }

      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
      }
      .tag {
        background: #f1f5f9;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        border: 1px solid #e2e8f0;
      }
      .tag-remove {
        margin-left: 8px;
        color: var(--danger);
        font-weight: bold;
        cursor: pointer;
      }

      #result-area { display: none; }
      .status-banner {
        padding: 15px;
        border-radius: 12px;
        font-weight: 800;
        text-align: center;
        margin-bottom: 15px;
        font-size: 1.1rem;
      }
      .danger-banner { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; }
      .success-banner { background: #dcfce7; color: var(--success); border: 1px solid #bbf7d0; }

      #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; }
      .hidden { display: none; }
      .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <button id="lang-btn" class="lang-toggle" onclick="toggleLanguage()">EN</button>
        <h1>üõ°Ô∏è V√©rifie Allerg√®nes</h1>
        <p id="ui-date-subtitle" style="font-size: 0.8rem; color: #64748b">
          4 F√©v  2026 - Version 1.2
        </p>
      </header>

      <div class="card">
        <label id="lbl-quick-add" style="font-weight: bold; font-size: 0.9rem">Quick Add Allergy</label>
        <div class="input-group" style="margin-top: 5px">
          <select id="allergy-dropdown"></select>
          <button id="btn-add-dropdown" class="btn btn-primary" onclick="addFromDropdown()">Add</button>
        </div>

        <div class="input-group">
          <input type="text" id="custom-allergy" placeholder="Or type custom..." />
          <button class="btn btn-secondary" onclick="addCustom()">+</button>
        </div>

        <div id="tag-list" class="tag-container"></div>
      </div>

      <div class="tabs">
        <button id="tab-manual" class="tab active" onclick="switchTab(event, 'manual')">Paste Text</button>
        <button id="tab-barcode" class="tab" onclick="switchTab(event, 'barcode')">Barcode</button>
        <button id="tab-photo" class="tab" onclick="switchTab(event, 'photo')">Photo OCR</button>
        <button id="tab-link" class="tab" onclick="switchTab(event, 'link')">URL</button>
      </div>

      <div id="barcode-view" class="tool-view hidden">
        <div id="reader"></div>
        <p id="ui-barcode-instruction" style="text-align: center; color: #64748b; font-size: 0.8rem">
          Center barcode in square
        </p>
      </div>

      <div id="photo-view" class="tool-view hidden">
        <div class="card" style="text-align: center">
          <input type="file" id="ocr-file" accept="image/*" capture="environment" style="display: none" onchange="handleOCR(event)" />
          <button id="btn-take-photo" class="btn btn-primary" style="width: 100%" onclick="document.getElementById('ocr-file').click()">
            üì∏ Take Label Photo
          </button>
          <div id="ocr-loader" class="hidden" style="margin-top: 15px">
            <div class="loader"></div>
            <span id="ui-reading-ing">Reading ingredients...</span>
          </div>
        </div>
      </div>

      <div id="link-view" class="tool-view hidden">
        <div class="card">
          <input type="text" id="url-input" placeholder="Paste Incidecoder URL..." />
          <button id="btn-analyze-url" class="btn btn-primary" style="width: 100%; margin-top: 10px" onclick="scrapeUrl()">
            Analyze Website
          </button>
        </div>
      </div>

      <div id="manual-view" class="tool-view hidden">
        <div class="card">
          <textarea id="manual-input" rows="6" placeholder="Paste ingredients list here..."></textarea>
          <div style="display: flex; gap: 10px; margin-top: 10px">
            <button id="btn-analyze-manual" class="btn btn-primary" style="flex: 2" onclick="analyzeManual()">Analyze</button>
            <button id="btn-clear-manual" class="btn btn-secondary" style="flex: 1" onclick="clearManual()">Clear</button>
          </div>
        </div>
      </div>

      <div id="result-area" class="card"></div>
    </div>

    <script>
      // --- TRADUCTION UI (Nouveau) ---
      let currentLang = localStorage.getItem("safescan_lang") || "fr";

      const uiStrings = {
        fr: {
          langBtn: "EN",
          quickAdd: "Ajout rapide d'allergie",
          add: "Ajouter",
          customPlace: "Ou tapez manuellement...",
          tabManual: "Texte",
          tabBarcode: "Code-barres",
          tabPhoto: "Photo OCR",
          tabLink: "URL",
          barcodeInstr: "Centrez le code-barres dans le carr√©",
          takePhoto: "üì∏ Prendre photo √©tiquette",
          reading: "Lecture des ingr√©dients...",
          urlPlace: "Coller URL Incidecoder...",
          analyze: "Analyser",
          clear: "Effacer",
          manualPlace: "Collez la liste des ingr√©dients ici...",
          safe: "‚úÖ SEMBLE S√õR",
          danger: "‚ö†Ô∏è ALERTE D√âTECT√âE",
          avoid: "√Ä √©viter :",
          viewText: "Voir le texte analys√©",
          newScan: "Nouveau scan"
        },
        en: {
          langBtn: "FR",
          quickAdd: "Quick Add Allergy",
          add: "Add",
          customPlace: "Or type custom...",
          tabManual: "Paste Text",
          tabBarcode: "Barcode",
          tabPhoto: "Photo OCR",
          tabLink: "URL",
          barcodeInstr: "Center barcode in square",
          takePhoto: "üì∏ Take Label Photo",
          reading: "Reading ingredients...",
          urlPlace: "Paste Incidecoder URL...",
          analyze: "Analyze",
          clear: "Clear",
          manualPlace: "Paste ingredients list here...",
          safe: "‚úÖ APPEARS SAFE",
          danger: "‚ö†Ô∏è TRIGGER FOUND",
          avoid: "Avoid:",
          viewText: "View Analyzed Text",
          newScan: "New Scan"
        }
      };

      function updateUI() {
        const s = uiStrings[currentLang];
        document.getElementById("lang-btn").innerText = s.langBtn;
        document.getElementById("lbl-quick-add").innerText = s.quickAdd;
        document.getElementById("btn-add-dropdown").innerText = s.add;
        document.getElementById("custom-allergy").placeholder = s.customPlace;
        document.getElementById("tab-manual").innerText = s.tabManual;
        document.getElementById("tab-barcode").innerText = s.tabBarcode;
        document.getElementById("tab-photo").innerText = s.tabPhoto;
        document.getElementById("tab-link").innerText = s.tabLink;
        document.getElementById("ui-barcode-instruction").innerText = s.barcodeInstr;
        document.getElementById("btn-take-photo").innerText = s.takePhoto;
        document.getElementById("ui-reading-ing").innerText = s.reading;
        document.getElementById("url-input").placeholder = s.urlPlace;
        document.getElementById("btn-analyze-url").innerText = s.analyze;
        document.getElementById("manual-input").placeholder = s.manualPlace;
        document.getElementById("btn-analyze-manual").innerText = s.analyze;
        document.getElementById("btn-clear-manual").innerText = s.clear;
      }

      function toggleLanguage() {
        currentLang = currentLang === "fr" ? "en" : "fr";
        localStorage.setItem("safescan_lang", currentLang);
        updateUI();
      }

      // --- VOS DICTIONNAIRES (INCHANG√âS) ---
      const GigiAllergens = ["Lanoline", "Bacitracin", "Paraben", "alcool benzylique", "baume du perou"];
      const fragranceMixes = [
        { id: "Mix II", label: "Fragrance mix II", ingredients: ["LYRAL", "CITRAL", "FARNESOL", "CITRONELLOL", "HEXYL CINNAMIC ALDEHYDE", "COUMARIN"] },
        { id: "Mix I", label: "Fragrance mix I", ingredients: ["G√âRANIOL", "EUG√âNOL", "ISOEUG√âNOL", "oakmoss abs."] }
      ];
      const allergyDict = {
        "baume du perou": ["balsam of peru", "baume du perou"],
        "alcool benzylique": ["benzyl alcohol", "alcool benzylique"],
        sulfate: ["laurylsulfate de sodium", "laurethsulfate de sodium", "laurylsulfate d ammonium", "coco-sulfate de sodium", "sodium lauryl sulfate", "sodium laureth sulfate", "ammonium lauryl sulfate", "sodium coco-sulfate"],
        paraben: ["m√©thylparab√®ne", "√©thylparab√®ne", "propylparab√®ne", "butylparab√®ne", "isobutylparab√®ne", "methylparaben", "ethylparaben", "propylparaben", "butylparaben", "isobutylparaben"],
        fragrance: ["parfum", "aroma", "fragrance", "linalool", "limonene", "geraniol", "citronellol", "eugenol"],
        lanolin: ["lanolin", "adeps lanae", "lanolin alcohol","lanoline","alcool de lanoline"]
        // ... (suite de votre dictionnaire actuel)
      };

      let userAllergies = JSON.parse(localStorage.getItem("safescan_allergies")) || [];
      if (userAllergies.length === 0) userAllergies = GigiAllergens;

      // --- LOGIC MODIFI√âE POUR LES R√âSULTATS BILINGUES ---
      function runAnalysis(productName, rawText) {
        const s = uiStrings[currentLang];
        const resultArea = document.getElementById("result-area");
        resultArea.style.display = "block";

        const cleanText = rawText.toLowerCase().replace(/\s+/g, " ").trim();
        let found = [];

        userAllergies.forEach((allergy) => {
          const aLower = allergy.toLowerCase();
          if (cleanText.includes(aLower)) {
            found.push(allergy);
          } else if (allergyDict[aLower]) {
            const match = allergyDict[aLower].find((str) => cleanText.includes(str));
            if (match) found.push(`${allergy} (as "${match}")`);
          }
        });

        const safe = found.length === 0;
        resultArea.innerHTML = `
            <div class="status-banner ${safe ? "success-banner" : "danger-banner"}">
                ${safe ? s.safe : s.danger}
            </div>
            <strong style="font-size:1.1rem;">${productName}</strong>
            ${!safe ? `<p style="color:var(--danger); font-weight:bold;">${s.avoid} ${found.join(", ")}</p>` : ""}
            <details style="margin-top:15px; font-size:0.8rem; color:#64748b;">
                <summary>${s.viewText}</summary>
                <p>${rawText}</p>
            </details>
            <button class="btn btn-secondary" style="width:100%; margin-top:15px;" onclick="resetApp()">${s.newScan}</button>
        `;
        window.scrollTo(0, document.body.scrollHeight);
      }

      // --- AUTRES FONCTIONS (INCHANG√âES SAUF APPEL √Ä UPDATEUI) ---
      const scanner = new Html5Qrcode("reader");

      function switchTab(e, view) {
        document.querySelectorAll(".tool-view").forEach((v) => v.classList.add("hidden"));
        document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
        document.getElementById(view + "-view").classList.remove("hidden");
        e.target.classList.add("active");
        if (view === "barcode") startScanner();
      }

      function startScanner() {
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
          scanner.stop().then(() => fetchBarcode(text));
        }).catch(() => {});
      }

      async function fetchBarcode(code) {
        const res = await fetch(`https://world.openbeautyfacts.org/api/v0/product/${code}.json`);
        const data = await res.json();
        if (data.status === 1) runAnalysis(data.product.product_name || "Barcode Product", data.product.ingredients_text || "");
        else alert(currentLang === "fr" ? "Produit non trouv√©." : "Product not found.");
      }

      async function handleOCR(e) {
        const loader = document.getElementById("ocr-loader");
        loader.classList.remove("hidden");
        const worker = await Tesseract.createWorker(["eng", "fra"]);
        const { data: { text } } = await worker.recognize(e.target.files[0]);
        await worker.terminate();
        loader.classList.add("hidden");
        runAnalysis("Scanned Label", text);
      }

      function removeAccents(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }

      function analyzeManual() {
        let cleanText = document.getElementById("manual-input").value;
        cleanText = cleanText.replace(/%\w\w/g, " ");
        cleanText = removeAccents(cleanText);
        runAnalysis(currentLang === "fr" ? "Saisie manuelle" : "Manual Paste", cleanText);
      }

      function init() {
        updateUI(); // Charger les textes
        const drop = document.getElementById("allergy-dropdown");
        Object.keys(allergyDict).sort().forEach((k) => {
          const opt = document.createElement("option");
          opt.value = k;
          opt.textContent = k.charAt(0).toUpperCase() + k.slice(1);
          drop.appendChild(opt);
        });
        updateTags();
        switchTab({ target: document.getElementById("tab-manual") }, 'manual');
      }

      function addFromDropdown() {
        const val = document.getElementById("allergy-dropdown").value;
        if (!userAllergies.includes(val)) { userAllergies.push(val); saveTags(); }
      }

      function addCustom() {
        const inp = document.getElementById("custom-allergy");
        if (inp.value) { userAllergies.push(inp.value.trim()); inp.value = ""; saveTags(); }
      }

      function removeTag(i) { userAllergies.splice(i, 1); saveTags(); }

      function saveTags() {
        localStorage.setItem("safescan_allergies", JSON.stringify(userAllergies));
        updateTags();
      }

      function updateTags() {
        document.getElementById("tag-list").innerHTML = userAllergies.map((a, i) => `
            <div class="tag">${a} <span class="tag-remove" onclick="removeTag(${i})">√ó</span></div>
        `).join("");
      }

      function clearManual() { document.getElementById("manual-input").value = ""; }
      function resetApp() { location.reload(); }

      window.onload = init;
    </script>
  </body>
</html>