<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SafeScan Canada</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #16a34a;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; padding: 0; 
        }

        .container { max-width: 500px; margin: 0 auto; padding: 15px; padding-bottom: 100px; }
        
        header { text-align: center; padding: 20px 0; }
        header h1 { margin: 0; font-size: 1.6rem; color: var(--primary); letter-spacing: -0.5px; }

        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        /* Tabs Navigation */
        .tabs { display: flex; gap: 4px; background: #e2e8f0; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px 5px; border: none; border-radius: 10px; cursor: pointer; background: transparent; font-weight: 600; font-size: 0.75rem; transition: 0.2s; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Allergy Management */
        .input-group { display: flex; gap: 8px; margin-bottom: 10px; }
        select, input, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 1rem; }
        .btn { padding: 12px 18px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #64748b; color: white; }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .tag { background: #f1f5f9; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; border: 1px solid #e2e8f0; }
        .tag-remove { margin-left: 8px; color: var(--danger); font-weight: bold; cursor: pointer; }

        /* Result Styles */
        #result-area { display: none; }
        .status-banner { padding: 15px; border-radius: 12px; font-weight: 800; text-align: center; margin-bottom: 15px; font-size: 1.1rem; }
        .danger-banner { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; }
        .success-banner { background: #dcfce7; color: var(--success); border: 1px solid #bbf7d0; }
        
        /* Scanner Container */
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; }
        .hidden { display: none; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üõ°Ô∏è SafeScan Canada</h1>
    </header>

    <div class="card">
        <label style="font-weight: bold; font-size: 0.9rem;">Quick Add Allergy</label>
        <div class="input-group" style="margin-top:5px;">
            <select id="allergy-dropdown"></select>
            <button class="btn btn-primary" onclick="addFromDropdown()">Add</button>
        </div>
        
        <div class="input-group">
            <input type="text" id="custom-allergy" placeholder="Or type custom...">
            <button class="btn btn-secondary" onclick="addCustom()">+</button>
        </div>

        <div id="tag-list" class="tag-container"></div>
    </div>

    <div class="tabs">        
        <button class="tab active" onclick="switchTab(event, 'manual')">Paste Text</button>
        <button class="tab" onclick="switchTab(event, 'barcode')">Barcode</button>
        <button class="tab" onclick="switchTab(event, 'photo')">Photo OCR</button>
        <button class="tab" onclick="switchTab(event, 'link')">URL</button>

    </div>

    <div id="barcode-view" class="tool-view">
        <div id="reader"></div>
        <p style="text-align:center; color:#64748b; font-size:0.8rem;">Center barcode in square</p>
    </div>

    <div id="photo-view" class="tool-view hidden">
        <div class="card" style="text-align:center;">
            <input type="file" id="ocr-file" accept="image/*" capture="environment" style="display:none" onchange="handleOCR(event)">
            <button class="btn btn-primary" style="width:100%" onclick="document.getElementById('ocr-file').click()">üì∏ Take Label Photo</button>
            <div id="ocr-loader" class="hidden" style="margin-top:15px;">
                <div class="loader"></div> <span style="font-size:0.9rem;">Reading ingredients...</span>
            </div>
        </div>
    </div>

    <div id="link-view" class="tool-view hidden">
        <div class="card">
            <input type="text" id="url-input" placeholder="Paste Incidecoder URL...">
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="scrapeUrl()">Analyze Website</button>
        </div>
    </div>

    <div id="manual-view" class="tool-view hidden">
        <div class="card">
            <textarea id="manual-input" rows="6" placeholder="Paste ingredients list here..."></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-primary" style="flex:2" onclick="analyzeManual()">Analyze</button>
                <button class="btn btn-secondary" style="flex:1" onclick="clearManual()">Clear</button>
            </div>
        </div>
    </div>

    <div id="result-area" class="card"></div>
</div>

<script>
    // --- DICTIONARY ---
    const allergyDict = {
    "sulfates": ["sodium lauryl sulfate", "sodium laureth sulfate", "ammonium lauryl sulfate", "sodium coco-sulfate"],
    "parabens": ["methylparaben", "ethylparaben", "propylparaben", "butylparaben", "isobutylparaben"],
    "fragrance": ["parfum", "aroma", "fragrance", "linalool", "limonene", "geraniol", "citronellol", "eugenol"],
    "phenoxyethanol": ["phenoxyethanol", "2-phenoxyethanol"],
    "formaldehyde releasers": ["dmdm hydantoin", "imidazolidinyl urea", "diazolidinyl urea", "quaternium-15"],
    "silicones": ["dimethicone", "cyclomethicone", "amodimethicone", "cyclopentasiloxane", "dimethiconol"],
    "isothiazolinones": ["methylisothiazolinone", "methylchloroisothiazolinone"], // Common in shampoos
    "alcohols (drying)": ["alcohol denat", "isopropyl alcohol", "sd alcohol", "ethanol"],
    "alcohols (fatty/safe)": ["cetyl alcohol", "stearyl alcohol", "cetearyl alcohol"],
    "phthalates": ["diethyl phthalate", "dep"],
    "mineral oil": ["paraffinum liquidum", "petrolatum", "cera microcristallina"],
    "lanolin": ["lanolin", "adeps lanae", "lanolin alcohol"],
    "nut oils": ["prunus amygdalus dulcis oil", "arachis hypogaea oil", "butyrospermum parkii butter"], // Almond, Peanut, Shea
    "coconut derivatives": ["cocos nucifera oil", "cocamidopropyl betaine", "coconut acid"],
    "vitamin c": ["ascorbic acid", "sodium ascorbyl phosphate", "ascorbyl palmitate"],
    "vitamin e": ["tocopherol", "tocopheryl acetate", "tocopheryl nicotinate"]toi;

    const allergyDictFr = { 
    "sulfates": ["laurylsulfate de sodium", "laurethsulfate de sodium", "laurylsulfate d ammonium", "coco-sulfate de sodium"],
    "parab√®nes": ["m√©thylparab√®ne", "√©thylparab√®ne", "propylparab√®ne", "butylparab√®ne", "isobutylparab√®ne"],
    "parfum": ["parfum", "ar√¥me", "fragrance", "linalol", "limon√®ne", "g√©raniol", "citronellol", "eug√©nol"],
    "ph√©noxy√©thanol": ["ph√©noxy√©thanol", "2-ph√©noxy√©thanol"],
    "lib√©rateurs de formald√©hyde": ["DMDM hydanto√Øne", "imidazolidinylur√©e", "diazolidinylur√©e", "quaternium-15"],
    "silicones": ["dim√©thicone", "cyclom√©thicone", "amodim√©thicone", "cyclopentasiloxane", "dim√©thiconol"],
    "isothiazolinones": ["m√©thylisothiazolinone", "m√©thylchloroisothiazolinone"], // Courant dans les shampoings
    "alcools (s√©chants)" : ["alcool d√©natur√©", "alcool isopropylique", "alcool SD", "√©thanol"],
    "alcools (gras/s√ªrs)" : ["alcool c√©tylique", "alcool st√©arylique", "alcool c√©t√©arylique"],
    "phtalates": ["phtalate de di√©thyle", "DEP"],
    "huile min√©rale": ["paraffinum liquidum", "petrolatum", "cera microcristallina"],
    "lanoline": ["lanoline", "adeps lanae", "alcool de lanoline"],
    "huiles de noix": ["huile de prunus amygdalus dulcis", "huile d'arachide hypogaea", "beurre de butyrospermum parki"], // Amande, arachide, karit√©
    "d√©riv√©s de noix de coco": ["huile de cocos nucifera", "cocamidopropyl b√©ta√Øne"], 
    "Acide de noix de coco" : ["acide ascorbique", "phosphate d'ascorbyle de sodium", "palmitate d'ascorbyle"],
    "Vitamine C" : ["tocoph√©rol", "ac√©tate de tocoph√©ryle", "nicotinate de tocoph√©ryle"],
};

    
    let userAllergies = JSON.parse(localStorage.getItem('safescan_allergies')) || ["sulfate"];

    // --- CORE LOGIC ---
    function runAnalysis(productName, rawText) {
        const resultArea = document.getElementById('result-area');
        resultArea.style.display = 'block';
        
        // Clean text: Unicode-aware (L = Letters, N = Numbers, s = whitespace)
        const cleanText = rawText.toLowerCase()
            .replace(/[^\p{L}\p{N}\s]/gu, ' ')
            .replace(/\s+/g, ' ')
            .replace(/%\w\w/g, ' ')
            .trim();

        let found = [];
        userAllergies.forEach(allergy => {
            const aLower = allergy.toLowerCase();
            if (cleanText.includes(aLower)) {
                found.push(allergy);
            } else if (allergyDict[aLower]) {
                const match = allergyDict[aLower].find(s => cleanText.includes(s));
                if (match) found.push(`${allergy} (as "${match}")`);
            }
        });

        const safe = found.length === 0;
        resultArea.innerHTML = `
            <div class="status-banner ${safe ? 'success-banner' : 'danger-banner'}">
                ${safe ? '‚úÖ APPEARS SAFE' : '‚ö†Ô∏è TRIGGER FOUND'}
            </div>
            <strong style="font-size:1.1rem;">${productName}</strong>
            ${!safe ? `<p style="color:var(--danger); font-weight:bold;">Avoid: ${found.join(', ')}</p>` : ''}
            <details style="margin-top:15px; font-size:0.8rem; color:#64748b;">
                <summary>View Analyzed Text</summary>
                <p>${rawText}</p>
            </details>
            <button class="btn btn-secondary" style="width:100%; margin-top:15px;" onclick="resetApp()">New Scan</button>
        `;
        window.scrollTo(0, document.body.scrollHeight);
    }

    // --- TOOL FUNCTIONS ---
    const scanner = new Html5Qrcode("reader");

    function switchTab(e, view) {
        document.querySelectorAll('.tool-view').forEach(v => v.classList.add('hidden'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(view + '-view').classList.remove('hidden');
        e.target.classList.add('active');
        
        if (view === 'barcode') startScanner();
        else scanner.stop().catch(() => {});
    }

    function startScanner() {
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
            scanner.stop().then(() => fetchBarcode(text));
        }).catch(() => {});
    }

    async function fetchBarcode(code) {
        const res = await fetch(`https://world.openbeautyfacts.org/api/v0/product/${code}.json`);
        const data = await res.json();
        if (data.status === 1) runAnalysis(data.product.product_name || "Barcode Product", data.product.ingredients_text || "");
        else alert("Product not found in database.");
    }

    async function handleOCR(e) {
        const loader = document.getElementById('ocr-loader');
        loader.classList.remove('hidden');
        const worker = await Tesseract.createWorker(['eng', 'fra']);
        const { data: { text } } = await worker.recognize(e.target.files[0]);
        await worker.terminate();
        loader.classList.add('hidden');
        runAnalysis("Scanned Label", text);
    }

    async function scrapeUrl() {
        const url = document.getElementById('url-input').value;
        const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
        const data = await res.json();
        const doc = new DOMParser().parseFromString(data.contents, 'text/html');
        const ings = doc.getElementById('ingred-list')?.innerText || "Ingredients not found.";
        runAnalysis("Website Link", ings);
    }

    function analyzeManual() {
        runAnalysis("Manual Paste", document.getElementById('manual-input').value);
    }

    // --- SETTINGS LOGIC ---
    function init() {
        const drop = document.getElementById('allergy-dropdown');
        Object.keys(allergyDict).sort().forEach(k => {
            const opt = document.createElement('option');
            opt.value = k; opt.textContent = k.charAt(0).toUpperCase() + k.slice(1);
            drop.appendChild(opt);
        });
        updateTags();
        // -- don't startScanner();
    }

    function addFromDropdown() {
        const val = document.getElementById('allergy-dropdown').value;
        if (!userAllergies.includes(val)) {
            userAllergies.push(val);
            saveTags();
        }
    }

    function addCustom() {
        const inp = document.getElementById('custom-allergy');
        if (inp.value) {
            userAllergies.push(inp.value.trim());
            inp.value = '';
            saveTags();
        }
    }

    function removeTag(i) {
        userAllergies.splice(i, 1);
        saveTags();
    }

    function saveTags() {
        localStorage.setItem('safescan_allergies', JSON.stringify(userAllergies));
        updateTags();
    }

    function updateTags() {
        document.getElementById('tag-list').innerHTML = userAllergies.map((a, i) => `
            <div class="tag">${a} <span class="tag-remove" onclick="removeTag(${i})">√ó</span></div>
        `).join('');
    }

    function clearManual() { document.getElementById('manual-input').value = ""; }
    function resetApp() { location.reload(); }

    window.onload = init;

    // Register Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(() => {});
    }
</script>
</body>
</html>
