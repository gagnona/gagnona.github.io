<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeScan Canada</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #16a34a;
            --bg: #f8fafc;
            --card: #ffffff;
        }

        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #1e293b; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        
        header { text-align: center; padding: 20px 0; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }

        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #e2e8f0; padding: 5px; border-radius: 10px; }
        .tab { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; background: transparent; font-weight: 600; font-size: 0.8rem; }
        .tab.active { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: var(--primary); }

        /* Cards */
        .card { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        /* Allergy Tags */
        .allergy-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input[type="text"] { flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; }
        .tag { display: inline-flex; align-items: center; background: #f1f5f9; padding: 5px 12px; border-radius: 20px; margin: 4px; font-size: 0.85rem; border: 1px solid #e2e8f0; }
        .tag-remove { margin-left: 8px; color: var(--danger); cursor: pointer; font-weight: bold; }

        /* Scanner/OCR Areas */
        #reader { width: 100%; border-radius: 10px; overflow: hidden; background: #000; }
        .hidden { display: none; }
        
        /* Results */
        .status-box { padding: 15px; border-radius: 10px; font-weight: bold; text-align: center; margin-bottom: 15px; }
        .status-warning { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; }
        .status-safe { background: #dcfce7; color: var(--success); border: 1px solid #bbf7d0; }
        .status-loading { background: #f1f5f9; color: #64748b; }

        .ingredients-detail { font-size: 0.8rem; color: #64748b; line-height: 1.4; border-top: 1px solid #e2e8f0; pt: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üõ°Ô∏è SafeScan Canada</h1>
    </header>

    <div class="card">
    <strong>My Allergies</strong>
    <p style="font-size: 0.75rem; color: #64748b; margin-top: 0;">Add custom or pick from common triggers:</p>
    
    <div class="allergy-input-group">
        <select id="common-allergy-select" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1;">
            <option value="">-- Quick Add Common --</option>
            </select>
        <button class="btn-add" onclick="addFromDropdown()" style="background: #64748b;">Add</button>
    </div>

    <div class="allergy-input-group" style="margin-top:10px;">
        <input type="text" id="allergy-input" placeholder="Or type custom (e.g. Peanut)">
        <button class="btn-add" onclick="addAllergy()">Add</button>
    </div>
    
    <div id="allergy-list"></div>
    </div>
 
    <div class="tabs">
        <button class="tab active" onclick="switchTab('barcode')">Barcode</button>
        <button class="tab" onclick="switchTab('photo')">Photo OCR</button>
        <button class="tab" onclick="switchTab('link')">Paste URL</button>
    </div>

    <div id="barcode-view" class="tool-view">
        <div id="reader"></div>
        <p style="text-align:center; font-size: 0.8rem;">Point camera at product barcode</p>
    </div>

    <div id="photo-view" class="tool-view hidden">
        <div class="card" style="text-align:center;">
            <input type="file" id="ocr-upload" accept="image/*" capture="environment" style="display:none" onchange="processOCR(event)">
            <button class="btn-add" style="width:100%;" onclick="document.getElementById('ocr-upload').click()">üì∏ Take Photo of Ingredients</button>
            <p id="ocr-status" style="font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="link-view" class="tool-view hidden">
        <div class="card">
            <input type="text" id="url-input" placeholder="Paste Incidecoder URL..." style="width:100%; box-sizing:border-box; margin-bottom:10px;">
            <button class="btn-add" style="width:100%;" onclick="checkByUrl()">Analyze URL</button>
        </div>
    </div>

    <div id="result-area" class="card hidden">
        </div>
</div>

<script>
    // --- DICTIONARY & STATE ---
const allergyDict = {
    "sulfates": ["sodium lauryl sulfate", "sodium laureth sulfate", "ammonium lauryl sulfate", "sodium coco-sulfate"],
    "parabens": ["methylparaben", "ethylparaben", "propylparaben", "butylparaben", "isobutylparaben"],
    "fragrance": ["parfum", "aroma", "fragrance", "linalool", "limonene", "geraniol", "citronellol", "eugenol"],
    "phenoxyethanol": ["phenoxyethanol", "2-phenoxyethanol"],
    "formaldehyde releasers": ["dmdm hydantoin", "imidazolidinyl urea", "diazolidinyl urea", "quaternium-15"],
    "silicones": ["dimethicone", "cyclomethicone", "amodimethicone", "cyclopentasiloxane", "dimethiconol"],
    "isothiazolinones": ["methylisothiazolinone", "methylchloroisothiazolinone"], // Common in shampoos
    "alcohols (drying)": ["alcohol denat", "isopropyl alcohol", "sd alcohol", "ethanol"],
    "alcohols (fatty/safe)": ["cetyl alcohol", "stearyl alcohol", "cetearyl alcohol"],
    "phthalates": ["diethyl phthalate", "dep"],
    "mineral oil": ["paraffinum liquidum", "petrolatum", "cera microcristallina"],
    "lanolin": ["lanolin", "adeps lanae", "lanolin alcohol"],
    "nut oils": ["prunus amygdalus dulcis oil", "arachis hypogaea oil", "butyrospermum parkii butter"], // Almond, Peanut, Shea
    "coconut derivatives": ["cocos nucifera oil", "cocamidopropyl betaine", "coconut acid"],
    "vitamin c": ["ascorbic acid", "sodium ascorbyl phosphate", "ascorbyl palmitate"],
    "vitamin e": ["tocopherol", "tocopheryl acetate", "tocopheryl nicotinate"],
    "disperse": ["disperse blue 1", "d&c blue no. 6"],
    "lanolin": ["lanolin", "adeps lanae", "lanolin alcohol"],
    "peruvian balsam": ["myroxylon pereirae", "balsam of peru","beaume du perou"]
    

};



    let myAllergies = JSON.parse(localStorage.getItem('canadianAllergies')) || ["sulfates"];
// 1. Populate the dropdown when the app starts
function populateDropdown() {
    const select = document.getElementById('common-allergy-select');
    // Get all keys from your dictionary (sulfate, vitamin e, etc.)
    const commonNames = Object.keys(allergyDict);
    
    commonNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        // Capitalize the first letter for the display
        option.textContent = name.charAt(0).toUpperCase() + name.slice(1);
        select.appendChild(option);
    });
}

// 2. Function to add the selected item from the dropdown
function addFromDropdown() {
    const select = document.getElementById('common-allergy-select');
    const selectedValue = select.value;
    
    if (selectedValue && !myAllergies.includes(selectedValue)) {
        myAllergies.push(selectedValue);
        saveAndRefresh();
        select.value = ""; // Reset dropdown
    }
}

// 3. Helper to save and update UI (reusing your existing logic)
function saveAndRefresh() {
    localStorage.setItem('canadianAllergies', JSON.stringify(myAllergies));
    displayAllergies();
}

    // --- UI LOGIC ---
    function switchTab(view) {
        document.querySelectorAll('.tool-view').forEach(v => v.classList.add('hidden'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(view + '-view').classList.remove('hidden');
        event.target.classList.add('active');
        
        if(view === 'barcode') startScanner();
        else html5QrCode.stop();
    }

    function displayAllergies() {
        const list = document.getElementById('allergy-list');
        list.innerHTML = myAllergies.map((a, i) => `
            <span class="tag">${a} <span class="tag-remove" onclick="removeAllergy(${i})">√ó</span></span>
        `).join('');
    }

    function addAllergy() {
        const input = document.getElementById('allergy-input');
        if(input.value) {
            myAllergies.push(input.value.trim());
            localStorage.setItem('canadianAllergies', JSON.stringify(myAllergies));
            input.value = '';
            displayAllergies();
        }
    }

    function removeAllergy(i) {
        myAllergies.splice(i, 1);
        localStorage.setItem('canadianAllergies', JSON.stringify(myAllergies));
        displayAllergies();
    }

    // --- ANALYSIS ENGINE ---
    function runAnalysis(productName, ingredients) {
        const resultArea = document.getElementById('result-area');
        resultArea.classList.remove('hidden');
        
        const lowerIng = ingredients.toLowerCase();
        let triggers = [];

        myAllergies.forEach(allergy => {
            const aLower = allergy.toLowerCase();
            if(lowerIng.includes(aLower)) triggers.push(allergy);
            else if(allergyDict[aLower]) {
                const syn = allergyDict[aLower].find(s => lowerIng.includes(s));
                if(syn) triggers.push(`${allergy} (${syn})`);
            }
        });

        const isSafe = triggers.length === 0;
        resultArea.innerHTML = `
            <div class="status-box ${isSafe ? 'status-safe' : 'status-warning'}">
                ${isSafe ? '‚úÖ APPEARS SAFE' : '‚ö†Ô∏è WARNING: TRIGGER FOUND'}
            </div>
            <h3>${productName}</h3>
            ${!isSafe ? `<p style="color:var(--danger)"><strong>Found:</strong> ${triggers.join(', ')}</p>` : ''}
            <div class="ingredients-detail">
                <strong>Ingredients Found:</strong><br>${ingredients}
            </div>
            <button class="btn-add" style="margin-top:15px; width:100%; background:#64748b;" onclick="location.reload()">Reset</button>
        `;
    }

    // --- BARCODE SCANNER ---
    const html5QrCode = new Html5Qrcode("reader");
    function startScanner() {
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
            html5QrCode.stop();
            fetchProduct(text);
        }).catch(() => {});
    }

    async function fetchProduct(barcode) {
        document.getElementById('result-area').innerHTML = "Searching OpenBeautyFacts...";
        document.getElementById('result-area').classList.remove('hidden');
        try {
            const res = await fetch(`https://world.openbeautyfacts.org/api/v0/product/${barcode}.json`);
            const data = await res.json();
            if(data.status === 1) runAnalysis(data.product.product_name, data.product.ingredients_text);
            else document.getElementById('result-area').innerHTML = "Product not in database. Use Photo OCR instead!";
        } catch(e) { alert("API Error"); }
    }

    // --- OCR ---
    async function processOCR(e) {
        const status = document.getElementById('ocr-status');
        status.innerText = "Initializing OCR Engine...";
        const worker = await Tesseract.createWorker(['eng', 'fra']); // Bilingual support
        const { data: { text } } = await worker.recognize(e.target.files[0]);
        await worker.terminate();
        runAnalysis("Scanned Label", text);
    }

    // --- URL SCRAPER ---
    async function checkByUrl() {
        const url = document.getElementById('url-input').value;
        const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
        const res = await fetch(proxy);
        const data = await res.json();
        const doc = new DOMParser().parseFromString(data.contents, 'text/html');
        const text = doc.getElementById('ingred-list')?.innerText || "Could not find ingredients.";
        runAnalysis("Website Result", text);
    }

    // Start
    displayAllergies();
    populateDropdown();
    displayAllergies();
 //   startScanner();
</script>

</body>
</html>
