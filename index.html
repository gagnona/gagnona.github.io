<!DOCTYPE html


    To change this license header, choose License Headers in Project Properties.
    To change this template file, choose Tools | Templates
    and open the template in the editor.
    -->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allergy Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        #reader { width: 100%; max-width: 500px; margin: auto; border: 2px solid #333; }
        .warning { background: #ff4d4d; color: white; padding: 15px; margin-top: 10px; border-radius: 8px; }
        .safe { background: #2ecc71; color: white; padding: 15px; margin-top: 10px; border-radius: 8px; }
        #resultArea { margin-top: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; }
    </style>
</head>
<body>

    <h1>Allergy Scanner</h1>
    <label for="barcode">Enter Barcode:</label><br>
    <input type="text" id="barcode" placeholder="e.g., 3270192323712">
    <button onclick="checkProduct()">Check Product</button>
    <div id="reader"></div>

    <div id="resultArea">
        <p><em>Scan a barcode to check ingredients...</em></p>
    </div>

    <script>
        const myAllergies = ["EDTA","Sulfate", "Linalool", "Fragrance", "Parabens","Phthalates","menthol","Alcohol","Gluten","Nut","Soy","Dairy"];

        // 3. Initialize the Scanner
        const html5QrCode = new Html5Qrcode("reader");
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            // Once a barcode is found, stop scanning and fetch data
            console.log(`Code found: ${decodedText}`);
            html5QrCode.stop().then(() => {
                checkProduct(decodedText);
            });
        };

        const config = { fps: 10, qrbox: { width: 250, height: 150 } };

        // Start the camera
        html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);

        // 4. The same logic from before to check the API
        async function checkProduct(decodedText) {
            const barcode = document.getElementById('barcode').value;
            resultArea.innerHTML = "Checking database..."+decodedText;

            try {
                const response = await fetch(`https://world.openbeautyfacts.org/api/v0/product/${decodedText}.json`);
                const data = await response.json();

                if (data.status === 0) {
                    resultArea.innerHTML = `<h3>❌ Not Found</h3><p>Barcode: ${decodedText}</p><button onclick="location.reload()">Scan Again</button>`;
                    return;
                }

                const name = data.product.product_name || "Unknown Product";
                const ingredients = data.product.ingredients_text || "";
                
                const foundAllergies = myAllergies.filter(a => ingredients.toLowerCase().includes(a.toLowerCase()));

                let html = `<h2>${name}</h2>`;
                if (foundAllergies.length > 0) {
                    html += `<div class="warning">⚠️ CONTAINS: ${foundAllergies.join(", ")}</div>`;
                } else {
                    html += `<div class="safe">✅ No known allergens found.</div>`;
                }

                html += `<p><strong>Ingredients:</strong> ${ingredients}</p>`;
                html += `<button onclick="location.reload()">Scan Next Item</button>`;
                
                resultArea.innerHTML = html;

            } catch (err) {
                resultArea.innerHTML = "Error connecting to database.";
            }
        }
    </script>
</body>
</html>
